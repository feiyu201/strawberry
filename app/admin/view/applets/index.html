<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>小程序管理</title>
		<link rel="stylesheet" href="/static/component/pear/css/pear.css" />
	</head>
<body class="pear-container">
<div class="layui-card">
			<div class="layui-card-body">
	<!--数据表格-->
	<table class="layui-hide" id="tableId" lay-filter="tableFilter"></table>
	</div>
		</div>


<!--js逻辑-->
<script src="/static/component/layui/layui.js"></script>
<script src="/static/component/pear/pear.js"></script>
<script>
		layui.use(['table', 'form', 'jquery', 'drawer', 'dropdown'], function() {
		let table = layui.table;
		let form = layui.form;
		let laydate = layui.laydate;
		let $ = layui.jquery;

		let userTable = table.render({
			elem: '#tableId',
			url: '{:url("index")}',
			limit: 20,
			page: true,
			toolbar: true,
			toolbar: "#toolbarTpl",
			defaultToolbar: [{
						layEvent: 'refresh',
						icon: 'layui-icon-refresh',
					}, 'filter', 'print', 'exports'],
			height: 'full',
			cellMinWidth: 120,
			skin: 'line',
			cols: [[
				{ type: "checkbox", fixed: "left" },
				{ field: "id", title: "ID", sort: true },
				{ field: "name", title: "名称" },

				{ field: "appid", title: "appid" },


				{ field: "secret", title: "secret" },

				{ field: "status", title: "状态", width: 100, templet: "#statusTpl" },
				{ title: "操作", align: "center", fixed: "right", templet: "#operationTpl" }
			]],
			done: function (res, curr, count) {
				console.info(res, curr, count);
			}
		});

		form.on("submit(search)", function (data) {
			userTable.reload({
				where: data.field,
				page: { curr: 1 }
			});
			return false;
		});

		table.on("toolbar(tableFilter)", function (obj) {
			switch (obj.event) {
				case "batchEnabled":
					batchEnabled();
					break;
				case "batchDisabled":
					batchDisabled();
					break;
				case "batchDel":
					batchDel();
					break;
				case "refresh":
					window.refresh();
					break;
				case "add":
					add();
					break;
			}
		});

		table.on("tool(tableFilter)", function (obj) {
			let data = obj.data;
			switch (obj.event) {
				case "edit":
					edit(data);
					break;
				case "del":
					del(obj);
					break;
				case "welcome":
					welcome(data);
					break;
			}
		});

		window.add = function() {
				layer.open({
                type: 2,
                maxmin: true,
                title: '{:__('Add')}',
                shade: 0.1,
                area: ['80%', '80%'],
                content: '{:url('add')}'
            });
				}
		
			window.edit = function(data) {
						layer.open({
                        type: 2,
                        maxmin: true,
                        title: '{:__('Edit')}',
                        shade: 0.1,
                        area: ['80%', '80%'],
						content: 'edit?id='+ data.id
					});
				}
		
		
			window.del = function(obj) {
                    layer.confirm('确定要删除吗？', {
                        icon: 3,
                        title: '提示'
                    }, function(index) {
                        layer.close(index);
                        let loading = layer.load();
                        $.ajax({
                            url:'{:url('delete')}',
                             data:{idsStr:obj.data['id']},
                            dataType: 'json',
                            type: 'POST',
                            success: function(res) {
                                layer.close(loading);
                                //判断有没有权限
                                if(res && res.code==999){
                                    layer.msg(res.msg, {
                                        icon: 5,
                                        time: 2000, 
                                    })
                                    return false;
                                }else if (res.code==1) {
                                    layer.msg(res.msg, {
                                        icon: 1,
                                        time: 1000
                                    }, function() {
                                        obj.del();
                                    });
                                } else {
                                    layer.msg(res.msg, {
                                        icon: 2,
                                        time: 1000
                                    });
                                }
                            }
                        })
                    });
                }
		
			window.refresh = function(param) {
					table.reload('tableId');
				}

		function welcome(data) {
			console.log(data);
			window.open("{:url('welcome')}?id=" + data.id);
		}
	})
</script>
<!-- 头工具栏模板 -->

	<script type="text/html" id="toolbarTpl">
		<button class="pear-btn pear-btn-primary pear-btn-md" lay-event="add">
			<i class="layui-icon layui-icon-add-1"></i>
			新增
		</button>
	 <!--	<button class="pear-btn pear-btn-danger pear-btn-md" lay-event="batchRemove">
			<i class="layui-icon layui-icon-delete"></i>
			删除
		</button> -->
	</script>


<!-- 行工具栏模板 -->
	<script type="text/html" id="operationTpl">
		{{#  if(d.addons != ''){ }}<button class="pear-btn pear-btn-primary pear-btn-sm" lay-event="welcome"><i class="layui-icon">&#xe68e;</i></button>{{#  } }}
		<button class="pear-btn pear-btn-primary pear-btn-sm" lay-event="edit"><i class="layui-icon layui-icon-edit"></i></button>
		<button class="pear-btn pear-btn-danger pear-btn-sm" lay-event="del"><i class="layui-icon layui-icon-delete"></i></button>
        <!-- <button class="pear-btn pear-btn-sm" id="more_{{d.userId}}"><i class="layui-icon layui-icon-triangle-d"></i></button> -->
	</script>




<script type="text/html" id="statusTpl">
	{{#  if(d.status == 'normal'){ }}
	<span class="layui-btn layui-btn-normal layui-btn-xs">启用</span>
	{{#  } else if(d.status != 'normal') { }}
	<span class="layui-btn layui-btn-warm layui-btn-xs">停用</span>
	{{#  } }}
</script>


<script type="text/html" id="logoTpl">
	<img src="{{d.avatar}}" style="width: auto;height: 100%;"/>
</script>
	</body>
</html>