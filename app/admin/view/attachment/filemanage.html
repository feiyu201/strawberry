<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>附件管理</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" type="text/css" href="https://www.layuicdn.com/layui/css/layui.css" />
    <link rel="stylesheet" href="/static/css/oksub.css">
    <link rel="stylesheet" href="/static/css/dragula.css">
    <script type="text/javascript" src="/static/lib/loading/okLoading.js"></script>
    <style>
        .icon-img-delete {
            position: absolute;
            right: 5px;
            top: 5px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 0px;
            z-index: 8
        }

        .layui-upload-img {
            width: 92px;
            height: 92px;
            margin: 0 10px 10px 0;
        }

        .layui-elip {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            width: 100px;
            line-height: 22px;
            height: 22px
        }

        .fileManager li {
            position: relative
        }

        .fileManager li::after {
            content: '';
            position: absolute;
            z-index: -1;
            width: 40px;
            height: 40px;
            right: 5px;
            bottom: 26px;
            background-image: url('/static/images/success_checked.jpg');
            background-repeat: no-repeat;
        }

        .fileManager li.checked::after {
            z-index: 3;
        }
    </style>
</head>

<body style='padding:10px'>
    <button type="button" class="layui-hide" id="test1"></button>
    <div class="layui-fluid">
        <div id="fileManager" lay-filter="test"></div>
    </div>
    <div style="text-align: right;position: absolute;left: 0;bottom: 10px;right: 10px">
        <button class="layui-btn layui-btn-normal submit">确认</button>
        <button class="layui-btn layui-btn-primary cancel">取消</button>
    </div>
</body>
<script src="/static/lib/layui/layui.js"></script>
<script>
    layui.config({
        base: '/static/lib/layui/extend/',
    })
    layui.extend({ 'fileManager': 'fileManager/fileManager_src' })
        .use(['fileManager', 'layer', 'upload', "okUtils", "okLayer"], function () {
            okLoading.close();
            var fileManager = layui.fileManager
                , $ = layui.$
                , upload = layui.upload
                , layer = layui.layer
                , model = Number('{$Request.param.model}'),
                imgList = [],
                imgLimit = 12,
                okUtils = layui.okUtils,
                okLayer = layui.okLayer;

            switch (model) {
                case 1:
                    break;
                case 2:
                    break;
                case 3:
                    break;
                case 4:
                    imgLimit = 1
                    break;

            }
            function getType(type) {
                if (String(type).indexOf('image') != -1) {
                    return 'image';
                }
                return type;
            }
            fileManager.render({
                elem: '#fileManager'
                , method: 'post'
                , btn_upload: true
                , id: 'fmTest'
                , btn_create: false
                , url: "{:url('attachment/getList',['sort'=>'id desc'])}"
                , icon_url: '/static/filemanage/ico/'
                , thumb: { 'nopic': '/static/filemanage/null-100x100.jpg', 'width': 100, 'height': 100 }
                , parseData: function (res) {
                    let _res = [];
                    _res.code = 0;
                    _res.data = [];

                    for (let item of res.data) {
                        _res.data.push({
                            'thumb': item.url,
                            'path': item.storage,
                            'type': getType(item.mimetype),
                            'name': item.sha1,
                            'id': item.id,
                            data: item
                        })
                    }
                    _res.count = res.count
                    return _res;
                }
                , page: { limit: 10 }

            });
            var upIns = upload.render({
                elem: '#test1' //绑定元素
                , url: "{:url('upload/attachment',['save'=>1])}" //改成您自己的上传接口
                , multiple: true
                , accept: 'file'
                , done: function (res) {
                    //上传完毕
                    console.log(res)
                    fileManager.reload('fmTest');
                    imgList = [];
                }
            })


            //监听图片上传事件
            fileManager.on('uploadfile(test)', function (obj) {
                //obj.obj 当前对象
                //obj.path 路径
                //更改上传组件参数
                upIns.config.data = { 'path': obj.path };
                upIns.config.done = function (res) {
                    fileManager.reload('fmTest');
                }
                var e = document.createEvent("MouseEvents");
                e.initEvent("click", true, true);
                document.getElementById("test1").dispatchEvent(e)
            });
            $('.submit').click(function () {
                getImages(imgList);
                parent.layer.close(parent.layer.getFrameIndex(window.name));
            })
            $('.cancel').click(function () {
                parent.layer.close(parent.layer.getFrameIndex(window.name));
            })
            fileManager.on('delete(test)', function (obj) {
                let idsStr = obj.obj.attr('data-id')
                layer.confirm('确认删除？', {
                    btn: ['确定', '取消'] //按钮
                }, function () {
                    okUtils.ajax("{:url('attachment/delete')}", "post", { idsStr }, true).done(function (response) {
                        if (response.code === 1) {
                            okLayer.greenTickMsg(response.msg, function () {
                                location.reload()
                            })
                        }
                    }).fail(function (error) {
                        console.log(error)
                    });
                }, function () {

                });

                console.log('delete')
            })
            //监听图片选择事件
            fileManager.on('pic(test)', function (obj) {
                if (imgList.length === imgLimit) {
                    return layer.msg(`只允许选择${imgLimit}张图片`);
                }
                let li = obj.obj;
                let data = obj.data.data;

                console.log(data)
                if (li.hasClass('checked')) {
                    li.removeClass('checked');

                    imgList.splice(data.url, 1)
                } else {
                    imgList.push(data.url)
                    li.addClass('checked');
                }
            });

        });
</script>

</html>